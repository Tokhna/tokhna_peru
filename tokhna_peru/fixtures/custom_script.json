[
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Supplier", 
  "modified": "2018-12-24 15:44:07.536995", 
  "name": "Supplier-Client", 
  "parent": null, 
  "parentfield": null, 
  "parenttype": null, 
  "script": "cur_frm.add_fetch('nombre_tipo_documento', 'codigo_tipo_documento', 'codigo_tipo_documento');\ncur_frm.add_fetch('nombre_tipo_transporte', 'codigo_tipo_transporte', 'codigo_tipo_transporte');", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Company", 
  "modified": "2018-11-27 17:02:53.846817", 
  "name": "Company-Client", 
  "parent": null, 
  "parentfield": null, 
  "parenttype": null, 
  "script": "cur_frm.add_fetch('tipo_documento_identidad', 'codigo_tipo_documento', 'codigo_tipo_documento');\ncur_frm.add_fetch('catalogo_existencias', 'codigo_catalogo', 'codigo_catalogo_existencias');", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Customer", 
  "modified": "2018-10-23 16:30:18.202097", 
  "name": "Customer-Client", 
  "parent": null, 
  "parentfield": null, 
  "parenttype": null, 
  "script": "cur_frm.add_fetch('tipo_documento_identidad', 'codigo_tipo_documento', 'codigo_tipo_documento');", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Purchase Invoice", 
  "modified": "2020-02-02 19:43:50.331911", 
  "name": "Purchase Invoice-Client", 
  "parent": null, 
  "parentfield": null, 
  "parenttype": null, 
  "script": "cur_frm.add_fetch('tipo_comprobante', 'codigo_tipo_comprobante', 'codigo_comprobante');\ncur_frm.add_fetch('supplier', 'codigo_tipo_documento', 'codigo_tipo_documento');\ncur_frm.add_fetch('supplier', 'nombre_tipo_documento', 'tipo_documento_identidad');\n", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Sales Invoice", 
  "modified": "2020-02-03 00:08:57.028310", 
  "name": "Sales Invoice-Client", 
  "parent": null, 
  "parentfield": null, 
  "parenttype": null, 
  "script": "cur_frm.add_fetch('customer', 'codigo_tipo_documento', 'codigo_tipo_documento');\ncur_frm.add_fetch('customer', 'tipo_documento_identidad', 'tipo_documento_identidad');\ncur_frm.add_fetch('tipo_transaccion_sunat', 'codigo_tipo_transaccion', 'codigo_transaccion_sunat');\ncur_frm.add_fetch('tipo_nota_credito', 'codigo_notas_credito', 'codigo_nota_credito');\n\nfunction get_document_series(frm, cdt, cdn) {\n\tfrappe.call({\n\t\ttype: \"GET\",\n\t\tmethod: \"tokhna_peru.tokhna_peru.doctype.configuracion_nubefact.configuracion_nubefact.get_doc_serie\",\n\t\targs: {\n            company: frm.doc.company,\n\t\t\tdoctype: frm.doc.doctype,\n\t\t\tis_return: frm.doc.is_return ? \"1\" : \"0\",\n\t\t\tes_nota_debito: frm.doc.es_nota_debito ? \"1\" : \"0\",\n\t\t\tcontingencia: frm.doc.contingencia ? \"1\" : \"0\",\n\t\t\tcodigo_tipo_documento: frm.doc.codigo_tipo_documento\n\t\t},\n\t\tcallback: function(r) {\n\t\t\tfrappe.model.set_value(cdt, cdn, \"tipo_comprobante\", r.message.descripcion);\n\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_comprobante\", r.message.codigo);\n\t\t\tfrm.set_df_property(\"naming_series\", \"options\", r.message.series);\n\t\t}\n\t});\n}\nfunction get_document_transaction(frm, cdt, cdn) {\n\tfrappe.call({\n\t\ttype: \"GET\",\n\t\tmethod: \"tokhna_peru.tokhna_peru.doctype.tipos_de_transaccion_sunat.tipos_de_transaccion_sunat.get_tipo_transaccion\",\n\t\targs: {\n\t\t\tcustomer: frm.doc.customer,\n\t\t\tis_return: frm.doc.is_return ? \"1\" : \"0\"\n\t\t},\n\t\tcallback: function(r) {\n\t\t\tfrappe.model.set_value(cdt, cdn, \"tipo_transaccion_sunat\", r.message.descripcion);\n\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_transaccion_sunat\", r.message.codigo);\n\t\t}\n\t});\n}\nfunction get_product_anticipo(frm, cdt, cdn) {\n\tif (frm.doc.codigo_transaccion_sunat == \"4\") {\n\t\tfrappe.call({\n\t\t\ttype: \"GET\",\n            method: \"tokhna_peru.tokhna_peru.doctype.configuracion_nubefact.configuracion_nubefact.get_product_anticipo\",\n            args: {\n                company: frm.doc.company\n            },\n\t\t\tcallback: function(r) {\n\t\t\t\tif (r.message) {\n\t\t\t\t\tif (frm.doc.sales_invoice_advance === undefined){\n\t\t\t\t\t\tcur_frm.set_query(\"item_code\", \"items\", function(){\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\"filters\": [\n\t\t\t\t\t\t\t\t\t[\"Item\", \"name\", \"in\", r.message]]\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tcur_frm.set_query(\"item_code\", \"items\", function(){\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\"filters\": [\n\t\t\t\t\t\t\t\t\t[\"Item\", \"name\", \"!=\", r.message]]\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tcur_frm.clear_table(\"items\");\n\t\t\t\t\tfrm.refresh_field(\"items\");\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\telse {\n\t\tfrappe.model.set_value(cdt, cdn, \"sales_invoice_advance\", \"\");\n\t\tcur_frm.toggle_display(\"sales_invoice_advance\", false);\n\t}\n}\nfunction get_sales_invoice_advance(frm, cdt, cdn) {\n\tif (frm.doc.codigo_transaccion_sunat == \"4\") {\n\t\tcur_frm.set_query(\"sales_invoice_advance\" , function(){\n\t\t\treturn {\n\t\t\t\t\"filters\": [\n\t\t\t\t[\"Sales Invoice\", \"codigo_transaccion_sunat\", \"=\", \"4\"],\n\t\t\t\t[\"Sales Invoice\", \"customer\", \"=\", frm.doc.customer],\n\t\t\t\t[\"Sales Invoice\", \"sales_invoice_advance\", \"=\", null]]\n\t\t\t};\n\t\t});\n\t}\n\telse {\n\t\tfrappe.model.set_value(cdt, cdn, \"sales_invoice_advance\", \"\");\n\t}\n}\nfunction get_document_customer(frm, cdt, cdn){\n\treturn new Promise(function(resolve, reject) {\n\t\tif (frm.doc.customer){\n\t\t\tvar values = frappe.db.get_doc(\"Customer\", frm.doc.customer);\n\t\t\tresolve(values);\n\t\t}\n\t}).then(function(values) {\n\t\tfrappe.model.set_value(cdt, cdn, \"codigo_tipo_documento\", values.codigo_tipo_documento);\n\t\tfrappe.model.set_value(cdt, cdn, \"tipo_documento_identidad\", values.tipo_documento_identidad);\n\t\tfrm.refresh_fields();\n\t\tget_document_series(frm, cdt, cdn);\n\t\tget_document_transaction(frm, cdt, cdn);\n\t});\n}\nfrappe.ui.form.on(\"Sales Invoice\", {\n\ttipo_transaccion_sunat: function(frm, cdt, cdn){\n\t\tget_product_anticipo(frm, cdt, cdn);\n\t\tget_sales_invoice_advance(frm, cdt, cdn);\n\t}\n});\nfrappe.ui.form.on(\"Sales Invoice\", {\n\tsales_invoice_advance: function(frm, cdt, cdn){\n\t\tget_product_anticipo(frm, cdt, cdn);\n\t}\n});\nfrappe.ui.form.on(\"Sales Invoice\", {\n\tcustomer: function(frm, cdt, cdn) {\n\t\tif (frm.doc.codigo_tipo_documento) {\n\t\t\tget_document_series(frm, cdt, cdn);\n            get_document_transaction(frm, cdt, cdn);\n            set_pos_profile(frm, cdt, cdn);\n\t\t} else {\n\t\t\tfrappe.model.set_value(cdt, cdn, \"tipo_comprobante\", null);\n\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_comprobante\", null);\n\t\t\tfrappe.model.set_value(cdt, cdn, \"tipo_transaccion_sunat\", null);\n\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_transaccion_sunat\", null);\n\t\t}\n\t}\n});\nfrappe.ui.form.on(\"Sales Invoice\", {\n\tnaming_series: function(frm, cdt, cdn) {\n\t\tset_pos_profile(frm, cdt, cdn);\n\t}\n});\nfrappe.ui.form.on(\"Sales Invoice\", {\n\tcontingencia: function(frm, cdt, cdn) {\n\t\tif (frm.doc.codigo_tipo_documento && frm.doc.contingencia == 1) {\n\t\t\tget_document_series(frm, cdt, cdn);\n\t\t}\n\t}\n});\nfrappe.ui.form.on(\"Sales Invoice\", {\n\tis_return: function(frm, cdt, cdn) {\n\t\tif (frm.doc.codigo_tipo_documento && frm.doc.is_return == 1) {\n\t\t\tget_document_series(frm, cdt, cdn);\n\t\t}\n\t}\n});\nfrappe.ui.form.on('Sales Invoice', {\n\tbefore_submit: function(frm, cdt, cdn) {\n\t\tif(!frm.doc.customer_address && frm.doc.codigo_tipo_documento != \"-\"){\n            frappe.validated = false;\n            frappe.throw(\"Customer Address is missing\");\n        }\n        if (frm.doc.estado_sunat == null || frm.doc.is_return == 1) {\n            return new Promise(function(resolve, reject) {\n\t\t\t\tfrappe.call({\n                    method: \"tokhna_peru.tokhna_peru.facturacion_electronica.consult_document\",\n                    args: {\n                        'company': frm.doc.company,\n                        'invoice': frm.doc.name,\n                        'doctype': frm.doc.doctype\n                    },\n                    callback: function(values) {\n                        resolve(values);\n                    }\n                });\n\t\t\t}).then(function(values) {\n                if (values.message.codigo == \"24\"){\n                    frappe.call({\n                        method: \"tokhna_peru.tokhna_peru.facturacion_electronica.send_document\",\n                        args: {\n                            'company': frm.doc.company,\n                            'invoice': frm.doc.name,\n                            'doctype': frm.doc.doctype\n                        },\n                        callback: function(data) {\n                            console.log(data);\n                            if (data.message.codigo_hash) {\n                                frappe.model.set_value(cdt, cdn, \"estado_sunat\", (data.message.codigo_hash != \"\") ? (\"Aceptado\") : (\"Rechazado\"));\n                                frappe.model.set_value(cdt, cdn, \"respuesta_sunat\", data.message.sunat_descripcion);\n                                frappe.model.set_value(cdt, cdn, \"codigo_qr_sunat\", data.message.cadena_para_codigo_qr);\n                                frappe.model.set_value(cdt, cdn, \"codigo_barras_sunat\", data.message.codigo_de_barras);\n\t\t\t\t\t\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_hash_sunat\", data.message.codigo_hash);\n\t\t\t\t\t\t\t\tfrappe.model.set_value(cdt, cdn, \"enlace_pdf\", data.message.enlace_del_pdf);\n\t\t\t\t\t\t\t\twindow.open(data.message.enlace_del_pdf);\n                            } else{\n                                frappe.validated = false;\n                                frappe.throw(data.message.errors);\n                            }\n                        }\n                    });\n                } else {\n                    frappe.model.set_value(cdt, cdn, \"estado_sunat\", (values.message.codigo_hash != \"\") ? (\"Aceptado\") : (\"Rechazado\"));\n                    frappe.model.set_value(cdt, cdn, \"respuesta_sunat\", values.message.sunat_descripcion);\n                    frappe.model.set_value(cdt, cdn, \"codigo_qr_sunat\", values.message.cadena_para_codigo_qr);\n                    frappe.model.set_value(cdt, cdn, \"codigo_barras_sunat\", values.message.codigo_de_barras);\n\t\t\t\t\tfrappe.model.set_value(cdt, cdn, \"codigo_hash_sunat\", values.message.codigo_hash);\n\t\t\t\t\tfrappe.model.set_value(cdt, cdn, \"enlace_pdf\", values.message.enlace_del_pdf);\n\t\t\t\t\twindow.open(values.message.enlace_del_pdf);\n                }\n\t\t\t});\n        }\n\t}\n});\nfrappe.ui.form.on('Sales Invoice', {\n\trefresh: function(frm, cdt, cdn) {\n\t\tif (frm.doc.is_return == 1) {\n\t\t\tget_document_series(frm, cdt, cdn);\n\t\t}\n\t\tif (frm.doc.__islocal == 1){\n\t\t\tif (frm.doc.customer){\n\t\t\t\tget_document_customer(frm, cdt, cdn);\n\t\t\t}\t\t\t\n\t\t}\n\t}\n});\nfrappe.ui.form.on(\"Sales Invoice\", {\n\tbefore_cancel: function(frm, cdt, cdn) {\n\t\treturn new Promise(function(resolve, reject) {\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"tokhna_peru.tokhna_peru.facturacion_electronica.consult_document\",\n\t\t\t\targs: {\n\t\t\t\t\t'company': frm.doc.company,\n\t\t\t\t\t'invoice': frm.doc.name,\n\t\t\t\t\t'doctype': frm.doc.doctype\n\t\t\t\t},\n\t\t\t\tcallback: function(values) {\n\t\t\t\t\tresolve(values);\n\t\t\t\t}\n\t\t\t});\n\t\t}).then(function(values) {\n\t\t\tconsole.log(values);\n\t\t\tif (values.message.codigo != \"24\" && values.message != \"\"){\n\t\t\t\tif (frappe.datetime.get_day_diff(frm.doc.posting_date, frappe.datetime.get_today()) < 7 && frm.doc.estado_anulacion != \"En proceso\") {\n\t\t\t\t\treturn new Promise(function(resolve, reject) {\n\t\t\t\t\t\tfrappe.prompt([\n\t\t\t\t\t\t\t\t{ 'fieldname': 'motivo', 'fieldtype': 'Data', 'label': 'Motivo de la cancelacion', 'reqd': 1 }\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\tfunction(values) {\n\t\t\t\t\t\t\t\tresolve(values);\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t'Cancelacion de Comprobante',\n\t\t\t\t\t\t\t'Anular'\n\t\t\t\t\t\t);\n\t\t\t\t\t}).then(function(values) {\n\t\t\t\t\t\tfrappe.validated = false;\n\t\t\t\t\t\tfrappe.call({\n\t\t\t\t\t\t\tmethod: \"tokhna_peru.tokhna_peru.facturacion_electronica.cancel_document\",\n\t\t\t\t\t\t\targs: {\n\t\t\t\t\t\t\t\t'company': frm.doc.company,\n\t\t\t\t\t\t\t\t'invoice': frm.docname,\n\t\t\t\t\t\t\t\t'doctype': frm.doctype,\n\t\t\t\t\t\t\t\t'motivo': values.motivo\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tcallback: function(data) {\n\t\t\t\t\t\t\t\tfrappe.msgprint(\"<b>Esperando respuesta de SUNAT</b>\", 'Cancelaci\u00f3n');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tfrappe.validated = false;\n\t\t\t\t\tfrappe.msgprint(\"<b>Documento no se puede anular o esta en proceso de anulaci\u00f3n</b>\", 'Cancelaci\u00f3n');\n\t\t\t\t}\n\t\t\t} \n\t\t});\n\t}\n});\nfrappe.ui.form.on(\"Sales Invoice\", {\n\tonload: function(frm, cdt, cdn) {\n\t\tif (frm.doc.codigo_qr_sunat === undefined && frm.doc.estado_sunat == \"Aceptado\") {\n\t\t\tfrappe.model.set_value(cdt, cdn, \"estado_sunat\", null);\n\t\t}\n\t}\n});\nfunction set_pos_profile(frm, cdt, cdn) {\n\tif (frm.doc.__islocal == 1 && frm.doc.naming_series != \"\" && frm.doc.customer != \"\"){\n\t\tfrappe.db.get_list(\"POS Profile\", {filters: {selling_price_list: frm.doc.selling_price_list, naming_series: frm.doc.naming_series}}).then(pos_profiles => {\n\t\t\t$.each(pos_profiles, function(i, row){\n\t\t\t\tfrappe.db.get_doc(\"POS Profile\", row.name).then(pos_profile => {\n\t\t\t\t\t$.each(pos_profile.applicable_for_users, function(i, row){\n\t\t\t\t\t\tconsole.log(pos_profile);\n\t\t\t\t\t\tif (row.user == frappe.session.user){\n\t\t\t\t\t\t\tfrappe.model.set_value(cdt, cdn, \"is_pos\", 1);\n\t\t\t\t\t\t\tfrappe.model.set_value(cdt, cdn, \"pos_profile\", pos_profile.name);\n\t\t\t\t\t\t\tfrappe.model.set_value(cdt, cdn, \"set_warehouse\", pos_profile.warehouse);\n\t\t\t\t\t\t\tfrm.refresh_fields();\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n}\n", 
  "script_type": "Client"
 }
]